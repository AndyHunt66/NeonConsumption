<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Consumption Visualizer</title>
  <link rel="stylesheet" href="static/style.css">
  <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
</head>
<body>
  <h1>Project Consumption Dashboard</h1>



    <div class="controls">
    <!-- Drop‑down for Project ID -->
    <label for="project-id">Project:</label>
    <select id="project-id">
      <!-- <option value="" ></option>    -->
    </select>
    <select id="timescale">
      <option value="hourly">Hourly</option>
      <option value="daily">Daily</option>
      <option value="monthly">Monthly</option>
    </select>

  </div>

  <div id="charts">
    <div id="hourly-chart"></div>
    <div id="daily-chart"></div>
    <div id="monthly-chart"></div>
  </div>

  <script>
        /* --------- Populate project‑id drop‑down --------- */
    async function loadProjectIds() {
      const resp = await fetch('/api/projectids');
      const ids  = await resp.json(); 
      const sel  = document.getElementById('project-id');

      ids.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        sel.appendChild(opt);
      });
    }

    const renderGraph = () => {
      document.getElementById('hourly-chart').style.display = 'none';
      document.getElementById('daily-chart').style.display = 'none';
      document.getElementById('monthly-chart').style.display = 'none';

      const timescale = document.getElementById('timescale').value.trim();
      switch (timescale) {
        case 'hourly':
          document.getElementById('hourly-chart').style.display = 'block';
          return ['/api/consumption/hourly', 'hourly-chart', 'Hourly Consumption'];
        case 'daily':
          document.getElementById('daily-chart').style.display = 'block';
          return ['/api/consumption/daily', 'daily-chart', 'Daily Consumption'];
        case 'monthly':
          document.getElementById('monthly-chart').style.display = 'block';
          return ['/api/consumption/monthly', 'monthly-chart', 'Monthly Consumption'];
        default:
          return null;
      }
    };

    const dorender = () => {
      const proj = document.getElementById('project-id').value.trim();
      
      // Helper to fetch and plot
      async function fetchAndPlot(endpoint, chartId, title) {
        const res = await fetch(`${endpoint}?project_id=${proj}`);
        const data = await res.json();

        // Transform into arrays suitable for Plotly
        const x = data.map(row => row.timeframe_start);
        const yActive = data.map(row => row.active_time_seconds);
        const yCompute = data.map(row => row.compute_time_seconds);
        const yWritten = data.map(row => row.written_data_bytes);
        const yStorage = data.map(row => row.synthetic_storage_size_bytes);

        const traces = [
          { x, y: yActive, type: 'scatter', mode: 'lines+markers', name: 'Active Time' },
          { x, y: yCompute, type: 'scatter', mode: 'lines+markers', name: 'Compute Time' },
          { x, y: yWritten, type: 'scatter', mode: 'lines+markers', name: 'Written Data' },
          { x, y: yStorage, type: 'scatter', mode: 'lines+markers', name: 'Storage Size' },
        ];

        const layout = {
          title,
          xaxis: { title: 'Time' },
          yaxis: { title: 'Seconds / Bytes' },
          responsive: true
        };

        Plotly.newPlot(chartId, traces, layout);
      }
      
      const params = renderGraph();
      fetchAndPlot(params[0],params[1],params[2]);
    }

    document.getElementById('timescale').addEventListener('change', dorender);
    document.getElementById('project-id').addEventListener('change', dorender);

    loadProjectIds();        
    dorender();
   
  </script>
</body>
</html>