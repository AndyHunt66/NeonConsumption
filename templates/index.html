<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Consumption Visualizer</title>
  <link rel="stylesheet" href="static/style.css">
  <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
  <style>
    /* simple vertical stack */
    #charts div { margin-bottom: 30px; }
  </style>
</head>
<body>
  <h1>Project Consumption Dashboard</h1>

  <div class="controls">
    <label for="project-id">Project:</label>
    <select id="project-id"></select>
    <select id="timescale">
      <option value="hourly">Hourly</option>
      <option value="daily">Daily</option>
      <option value="monthly">Monthly</option>
    </select>
  </div>

  <!-- 4 separate divs for the 4 metrics -->
  <div id="charts">
    <div id="hourly-active"></div>
    <div id="hourly-compute"></div>
    <div id="hourly-written"></div>
    <div id="hourly-storage"></div>
    <div id="daily-active"></div>
    <div id="daily-compute"></div>
    <div id="daily-written"></div>
    <div id="daily-storage"></div>
    <div id="monthly-active"></div>
    <div id="monthly-compute"></div>
    <div id="monthly-written"></div>
    <div id="monthly-storage"></div>
  </div>

  <script>
    /* -------- Populate project‑id drop‑down -------- */
    async function loadProjectIds() {
      const resp = await fetch('/api/projectids');
      const ids  = await resp.json(); 
      const sel  = document.getElementById('project-id');
      ids.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        sel.appendChild(opt);
      });
    }

    const renderGraph = () => {
      // hide all
      const chartIds = ['hourly-active','hourly-compute','hourly-written','hourly-storage',
                        'daily-active','daily-compute','daily-written','daily-storage',
                        'monthly-active','monthly-compute','monthly-written','monthly-storage'];
      chartIds.forEach(id => document.getElementById(id).style.display = 'none');

      const timescale = document.getElementById('timescale').value.trim();
      let prefix, title;
      switch (timescale) {
        case 'hourly':  prefix = 'hourly';  title =  { text:'Hourly Consumption'}; break;
        case 'daily':   prefix = 'daily';   title = { text:'Daily Consumption'}; break;
        case 'monthly': prefix = 'monthly'; title = { text:'Monthly Consumption'}; break;
        default: return null;
      }
      // show the 4 charts for this timescale
      ['active','compute','written','storage'].forEach(m =>  
        document.getElementById(`${prefix}-${m}`).style.display = 'block');

      return ['/api/consumption/' + timescale, prefix, title];
    };

    const dorender = () => {
      const proj = document.getElementById('project-id').value.trim();
      const params = renderGraph();
      if (!params) return;
      const [endpoint, prefix, title] = params;

      async function fetchAndPlot() {
        const res  = await fetch(`${endpoint}?project_id=${proj}`);
        const data = await res.json();

        const x = data.map(r => r.timeframe_start);
        const y = {
          active:  data.map(r => r.active_time_seconds),
          compute: data.map(r => r.compute_time_seconds),
          written: data.map(r => r.written_data_bytes),
          storage: data.map(r => r.synthetic_storage_size_bytes)
        };
        const names = { active:'Active Time (seconds)', compute:'Compute Time (seconds)',
                        written:'Written Data (seconds)', storage:'Storage Size (bytes)' };

        ['active','compute','written','storage'].forEach(metric => {
          const trace = { x, y: y[metric], type:'scatter',
                          mode:'lines+markers', name:names[metric] };
          let tick;
          switch (prefix){
            case 'hourly':  tick = "%H~%M~%S.%2f" ; break; 
            case 'daily':   tick = "%H~%M~%S.%2f"  ; break;
            case 'monthly': tick = "%H~%M~%S.%2f"  ; break;
            default: return null;
          }
          const layout = { title:{ text:names[metric]}, xaxis:{title:'Time', tickformat:"%H" },
                           yaxis:{title:'Seconds / Bytes'}, responsive:true };
          Plotly.newPlot(`${prefix}-${metric}`, [trace], layout);
        });
      }

      fetchAndPlot();
    }

    document.getElementById('timescale').addEventListener('change', dorender);
    document.getElementById('project-id').addEventListener('change', dorender);

    loadProjectIds();
    dorender();
  </script>
</body>
</html>