<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Consumption Visualizer</title>
  <link rel="stylesheet" href="static/style.css">
  <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  
  <style>#charts div{margin-bottom:30px;}</style>
</head>
<body>
  <h1>Project Consumption Dashboard</h1>
  <div class="controls">
  <label>Project:</label>
  <div id="project-list"></div>          <!-- check‑boxes go here -->
  <label for="timescale">Timescale:</label>
  <select id="timescale">
    <option value="hourly">Hourly</option>
    <option value="daily">Daily</option>
    <option value="monthly">Monthly</option>
  </select>
</div>
  
  
  
  <div id="charts">
    <div id="hourly-active"></div>
    <div id="hourly-compute"></div>
    <div id="hourly-written"></div>
    <div id="hourly-storage"></div>

    <div id="daily-active"></div>
    <div id="daily-compute"></div>
    <div id="daily-written"></div>
    <div id="daily-storage"></div>

    <div id="monthly-active"></div>
    <div id="monthly-compute"></div>
    <div id="monthly-written"></div>
    <div id="monthly-storage"></div>
  </div>

<script>
async function loadProjectIds() {
  const ids  = await fetch('/api/projectids').then(r=>r.json());
  const list = document.getElementById('project-list');
  ids.forEach(id=>{
    const chk = document.createElement('input');
    chk.type   = 'checkbox';
    chk.id     = 'proj-'+id;
    chk.value  = id;
    chk.className = 'proj-chk';
    const lbl = document.createElement('label');
    lbl.htmlFor = chk.id;
    lbl.textContent = id;
    list.appendChild(chk);
    list.appendChild(lbl);
    list.appendChild(document.createElement('br'));
  });
}
 /* ----- Build & show graphs ----- */
async function dorender() {
  const timescale = document.getElementById('timescale').value.trim();
  const projects  = Array.from(document.querySelectorAll('.proj-chk:checked'))
                         .map(chk=>chk.value);

  document.querySelectorAll('#charts > div').forEach(d=>d.style.display='none');

  if (!projects.length) return;              // nothing selected → nothing shown

  const prefix = timescale;                   // "hourly","daily","monthly"
  const metrics = ['active','compute','written','storage'];
  const metricNames = {
    active:   'Active Time (seconds)',
    compute:  'Compute Time (seconds)',
    written:  'Written Data (bytes)',
    storage:  'Storage Size (bytes)'
  };
  const tickFormat = {
    hourly: '%d %b - %H:%M',
    daily:  '%Y-%m-%d',
    monthly:'%Y %b'
  }[timescale];

  /* show the four charts for this timescale */
  metrics.forEach(m=>document.getElementById(`${prefix}-${m}`).style.display='block');

  /* colour scheme */

  const colors = d3.scale.category10();
 
  /* build one trace per project per metric */
  const traces = {};
  await Promise.all(projects.map(async (proj,idx)=>{
    const res  = await fetch(`/api/consumption/${timescale}?project_id=${proj}`);
    const data = await res.json();

    const x = data.map(r=>new Date(r.timeframe_start));
    const y = {
      active:   data.map(r=>r.active_time_seconds),
      compute:  data.map(r=>r.compute_time_seconds),
      written:  data.map(r=>r.written_data_bytes),
      storage:  data.map(r=>r.synthetic_storage_size_bytes)
    };

    metrics.forEach(m=>{
      if (!traces[m]) traces[m]=[];
      traces[m].push({
        x, y: y[m],
        mode: 'lines+markers',
        name: proj,
        line: { color: colors(idx % 10) },
        marker: { size: 6 }
      });
    });
  }));

  /* plot each metric */
  metrics.forEach(m=>{
    const layout = {
      title: metricNames[m],
      xaxis: { title:'Time', tickformat: tickFormat },
      yaxis: { title:'Seconds / Bytes' },
      legend: { x:1, y:0.5, bgcolor:'rgba(255,255,255,0.5)' },
      responsive:true
    };
    Plotly.newPlot(`${prefix}-${m}`, traces[m], layout);
  });
}

/* event hooks */
document.getElementById('timescale').addEventListener('change', dorender);
document.getElementById('project-list').addEventListener('change', dorender);

/* init */
loadProjectIds().then(dorender);
</script>
</body>
</html>